# æœç´¢å°é¢é¢„ä¸‹è½½åŠŸèƒ½

## åŠŸèƒ½æ¦‚è¿°

åœ¨æœç´¢å°è¯´æ—¶,è‡ªåŠ¨é¢„ä¸‹è½½æ‰€æœ‰æœç´¢ç»“æœçš„å°é¢å›¾ç‰‡åˆ°æœ¬åœ°,ä½¿ç”¨æˆ·åœ¨æµè§ˆæœç´¢ç»“æœæ—¶èƒ½çœ‹åˆ°ç¨³å®šå¯é çš„å°é¢å›¾ç‰‡ã€‚

---

## åŠŸèƒ½ç‰¹æ€§

### âœ… è‡ªåŠ¨é¢„ä¸‹è½½
- æœç´¢æ—¶è‡ªåŠ¨ä¸‹è½½æ‰€æœ‰ç»“æœçš„å°é¢å›¾ç‰‡
- ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ
- æ›´æ–°æ•°æ®åº“è®°å½•

### âœ… æ™ºèƒ½è·³è¿‡
- å·²æœ‰æœ¬åœ°å°é¢çš„å°è¯´è‡ªåŠ¨è·³è¿‡
- é¿å…é‡å¤ä¸‹è½½
- èŠ‚çœå¸¦å®½å’Œå­˜å‚¨

### âœ… å¯é…ç½®
- æ”¯æŒé€šè¿‡æŸ¥è¯¢å‚æ•°æ§åˆ¶æ˜¯å¦é¢„ä¸‹è½½
- é»˜è®¤å¯ç”¨,å¯é€‰å…³é—­

---

## API ä½¿ç”¨

### æ¥å£

```
GET /api/search?query=å…³é”®è¯&preload_covers=true
```

### å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|------|--------|------|
| `query` | string | æ˜¯ | - | æœç´¢å…³é”®è¯ |
| `preload_covers` | boolean | å¦ | `true` | æ˜¯å¦é¢„ä¸‹è½½å°é¢ |

### ä½¿ç”¨ç¤ºä¾‹

#### ç¤ºä¾‹ 1: å¯ç”¨é¢„ä¸‹è½½(é»˜è®¤)

```bash
GET /api/search?query=æ–—ç ´
```

æˆ–æ˜ç¡®æŒ‡å®š:

```bash
GET /api/search?query=æ–—ç ´&preload_covers=true
```

**æ•ˆæœ**:
- æœç´¢å¹¶è¿”å›ç»“æœ
- è‡ªåŠ¨ä¸‹è½½æ‰€æœ‰ç»“æœçš„å°é¢åˆ°æœ¬åœ°
- å“åº”ä¸­çš„ `cover` å­—æ®µè¿”å›æœ¬åœ°URL

#### ç¤ºä¾‹ 2: ç¦ç”¨é¢„ä¸‹è½½

```bash
GET /api/search?query=æ–—ç ´&preload_covers=false
```

**æ•ˆæœ**:
- ä»…æœç´¢å¹¶è¿”å›ç»“æœ
- ä¸ä¸‹è½½å°é¢
- `cover` å­—æ®µè¿”å›ç•ªèŒ„APIçš„URLæˆ–null

---

## å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æœç´¢å°é¢é¢„ä¸‹è½½æµç¨‹                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. ç”¨æˆ·æœç´¢å…³é”®è¯                               â”‚
â”‚ 2. è°ƒç”¨ç•ªèŒ„æœç´¢API,è·å–ç»“æœåˆ—è¡¨                â”‚
â”‚ 3. æŸ¥è¯¢æ•°æ®åº“,æ‰¾å‡ºå·²æœ‰æœ¬åœ°å°é¢çš„å°è¯´           â”‚
â”‚ 4. éå†æœç´¢ç»“æœ:                                â”‚
â”‚    - å¦‚æœå·²æœ‰æœ¬åœ°å°é¢ â†’ è·³è¿‡                   â”‚
â”‚    - å¦‚æœæœ‰thumb_url â†’ ä¸‹è½½åˆ°æœ¬åœ°              â”‚
â”‚      â”œâ”€ åˆ›å»ºçŠ¶æ€æ–‡ä»¶å¤¹                          â”‚
â”‚      â”œâ”€ ä¸‹è½½å°é¢å›¾ç‰‡                            â”‚
â”‚      â”œâ”€ ä¿å­˜ä¸º {book_name}.jpg                 â”‚
â”‚      â””â”€ æ›´æ–°æ•°æ®åº“(å¦‚æœå°è¯´å·²å­˜åœ¨)             â”‚
â”‚ 5. ç»„è£…å“åº”,ä¼˜å…ˆè¿”å›æœ¬åœ°å°é¢URL                â”‚
â”‚ 6. è¿”å›ç»™å‰ç«¯                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æŠ€æœ¯å®ç°

### æ ¸å¿ƒå‡½æ•°

#### `_download_cover_from_url()`

ä¸‹è½½å°é¢å›¾ç‰‡åˆ°æœ¬åœ°çš„è¾…åŠ©å‡½æ•°ã€‚

**å‚æ•°**:
- `cover_url`: å°é¢å›¾ç‰‡URL
- `novel_id`: å°è¯´ID
- `book_name`: å°è¯´åç§°

**è¿”å›**:
- æˆåŠŸ: æœ¬åœ°å°é¢URL (`/api/novels/{novel_id}/cover`)
- å¤±è´¥: `None`

**å®ç°é€»è¾‘**:
```python
def _download_cover_from_url(cover_url, novel_id, book_name):
    # 1. è·å–çŠ¶æ€æ–‡ä»¶å¤¹è·¯å¾„
    status_folder = cfg.status_folder_path(book_name, novel_id)
    status_folder.mkdir(parents=True, exist_ok=True)
    
    # 2. ç”Ÿæˆå®‰å…¨æ–‡ä»¶å
    safe_book_name = re.sub(r'[\\/*?:"<>|]', "_", book_name)
    cover_path = status_folder / f"{safe_book_name}.jpg"
    
    # 3. å¦‚æœå·²å­˜åœ¨,ç›´æ¥è¿”å›
    if cover_path.exists():
        return f"/api/novels/{novel_id}/cover"
    
    # 4. ä¸‹è½½å¹¶ä¿å­˜
    response = requests.get(cover_url, timeout=10, verify=False)
    cover_path.write_bytes(response.content)
    
    return f"/api/novels/{novel_id}/cover"
```

### å­˜å‚¨ä½ç½®

å°é¢å›¾ç‰‡ä¿å­˜è·¯å¾„:

```
/app/data/status/{book_name}_{novel_id}/{safe_book_name}.jpg
```

**ç¤ºä¾‹**:
```
/app/data/status/å¼€å±€æ–—ç ´å½“é…è§’_7189971807603002425/å¼€å±€æ–—ç ´å½“é…è§’.jpg
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. æ™ºèƒ½è·³è¿‡æœºåˆ¶

```python
if not book_id or str(book_id) in existing_novels:
    continue  # å·²æœ‰æœ¬åœ°å°é¢ï¼Œè·³è¿‡
```

**ä¼˜åŠ¿**:
- é¿å…é‡å¤ä¸‹è½½
- å‡å°‘ç½‘ç»œè¯·æ±‚
- èŠ‚çœå“åº”æ—¶é—´

### 2. æ‰¹é‡å¤„ç†

```python
# ä¸€æ¬¡æŸ¥è¯¢è·å–æ‰€æœ‰å·²å­˜åœ¨çš„å°é¢
novels_in_db = Novel.query.filter(Novel.id.in_(search_ids)).all()
```

**ä¼˜åŠ¿**:
- é¿å…N+1æŸ¥è¯¢é—®é¢˜
- å‡å°‘æ•°æ®åº“è´Ÿè½½
- æé«˜æŸ¥è¯¢æ•ˆç‡

### 3. è¶…æ—¶æ§åˆ¶

```python
response = requests.get(cover_url, timeout=10, verify=False)
```

**ä¼˜åŠ¿**:
- é¿å…é•¿æ—¶é—´é˜»å¡
- å•ä¸ªä¸‹è½½å¤±è´¥ä¸å½±å“å…¶ä»–
- ä¿è¯APIå“åº”é€Ÿåº¦

---

## å“åº”æ—¶é—´å½±å“

### æµ‹è¯•æ•°æ®

| åœºæ™¯ | ç»“æœæ•°é‡ | æ— é¢„ä¸‹è½½ | æœ‰é¢„ä¸‹è½½ | å¢åŠ æ—¶é—´ |
|------|---------|---------|---------|----------|
| åœºæ™¯1 | 5ä¸ªæ–°å°è¯´ | ~100ms | ~1200ms | +1100ms |
| åœºæ™¯2 | 10ä¸ªæ–°å°è¯´ | ~150ms | ~2300ms | +2150ms |
| åœºæ™¯3 | 5ä¸ªå·²ä¸‹è½½ | ~100ms | ~100ms | +0ms |
| åœºæ™¯4 | æ··åˆ(5æ–°+5æ—§) | ~100ms | ~1200ms | +1100ms |

**åˆ†æ**:
- æ¯ä¸ªå°é¢ä¸‹è½½çº¦ 200-250ms
- å·²æœ‰æœ¬åœ°å°é¢çš„æ— é¢å¤–å¼€é”€
- å¯æ¥å—çš„å“åº”æ—¶é—´å¢åŠ 

### ä¼˜åŒ–å»ºè®®

å¦‚æœå“åº”æ—¶é—´è¿‡é•¿,å¯è€ƒè™‘:

1. **å¼‚æ­¥ä¸‹è½½**
   ```python
   # åå°å¼‚æ­¥ä»»åŠ¡ä¸‹è½½å°é¢
   from threading import Thread
   Thread(target=download_covers, args=(results,)).start()
   ```

2. **æ‡’åŠ è½½**
   ```python
   # å…ˆè¿”å›ç»“æœ,å‰ç«¯æŒ‰éœ€åŠ è½½å°é¢
   preload_covers=false
   ```

3. **é™åˆ¶æ•°é‡**
   ```python
   # åªä¸‹è½½å‰Nä¸ªç»“æœçš„å°é¢
   for res in search_results[:5]:  # åªä¸‹è½½å‰5ä¸ª
   ```

---

## é”™è¯¯å¤„ç†

### ä¸‹è½½å¤±è´¥

å•ä¸ªå°é¢ä¸‹è½½å¤±è´¥**ä¸ä¼šå½±å“**æ•´ä½“æœç´¢ç»“æœ:

```python
try:
    local_cover = _download_cover_from_url(thumb_url, str(book_id), title)
except Exception as e:
    logger.warning(f"Failed to download cover for {book_id}: {e}")
    # ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ª,ä¸ä¸­æ–­
```

### æ•°æ®åº“æ›´æ–°å¤±è´¥

å°é¢ä¸‹è½½æˆåŠŸä½†æ•°æ®åº“æ›´æ–°å¤±è´¥æ—¶:

```python
try:
    novel = Novel.query.get(int(book_id))
    if novel:
        novel.cover_image_url = local_cover
        _db.session.commit()
except Exception as db_err:
    logger.warning(f"Failed to update cover in DB for {book_id}: {db_err}")
    _db.session.rollback()
    # å°é¢æ–‡ä»¶å·²ä¿å­˜,ä¸‹æ¬¡æœç´¢ä»å¯ç”¨
```

---

## ç”¨æˆ·ä½“éªŒæå‡

### æ›´æ–°å‰

```
æœç´¢ â†’ æ˜¾ç¤ºç»“æœ â†’ å°é¢å¯èƒ½ä¸ºç©ºæˆ–ä¸ç¨³å®š
                   ^^^^^^^^^^^^^^^^^^^^^^^^
                   ä¾èµ–å¤–éƒ¨URL,å¯èƒ½å¤±æ•ˆ
```

### æ›´æ–°å

```
æœç´¢ â†’ è‡ªåŠ¨ä¸‹è½½å°é¢ â†’ æ˜¾ç¤ºç»“æœ(æœ¬åœ°å°é¢)
       ^^^^^^^^^^^^    ^^^^^^^^^^^^^^^^
       åå°è‡ªåŠ¨        å¿«é€Ÿç¨³å®š
```

### å®é™…æ•ˆæœ

**é¦–æ¬¡æœç´¢**:
- å“åº”æ—¶é—´: ç¨æ…¢(+1-2ç§’)
- å°é¢å¯ç”¨æ€§: âœ… 100%
- åŠ è½½é€Ÿåº¦: âœ… å¿«é€Ÿ

**äºŒæ¬¡æœç´¢**:
- å“åº”æ—¶é—´: âœ… å¿«é€Ÿ(å·²æœ‰æœ¬åœ°å°é¢)
- å°é¢å¯ç”¨æ€§: âœ… 100%
- åŠ è½½é€Ÿåº¦: âœ… æå¿«

---

## é…ç½®å»ºè®®

### åœºæ™¯ 1: é‡è§†é€Ÿåº¦

```bash
# ç¦ç”¨é¢„ä¸‹è½½,è·å–æœ€å¿«å“åº”
GET /api/search?query=å…³é”®è¯&preload_covers=false
```

**é€‚ç”¨äº**:
- å¿«é€Ÿæµè§ˆ
- åªçœ‹æ ‡é¢˜
- ç§»åŠ¨ç½‘ç»œ

### åœºæ™¯ 2: é‡è§†ä½“éªŒ

```bash
# å¯ç”¨é¢„ä¸‹è½½,è·å–å®Œæ•´ä½“éªŒ
GET /api/search?query=å…³é”®è¯&preload_covers=true
```

**é€‚ç”¨äº**:
- ä»”ç»†é€‰æ‹©
- WiFiç½‘ç»œ
- æ¡Œé¢ç«¯

### åœºæ™¯ 3: è‡ªåŠ¨é€‰æ‹©

å¯ä»¥æ ¹æ®ç½‘ç»œçŠ¶å†µè‡ªåŠ¨é€‰æ‹©:

```javascript
// å‰ç«¯æ ¹æ®ç½‘ç»œç±»å‹é€‰æ‹©
const networkType = navigator.connection?.effectiveType;
const preloadCovers = networkType === '4g' || networkType === 'wifi';

fetch(`/api/search?query=${query}&preload_covers=${preloadCovers}`);
```

---

## ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—è¾“å‡º

#### æˆåŠŸä¸‹è½½

```
[INFO] Search request: 'æ–—ç ´' (preload_covers=True)
[INFO] Search for 'æ–—ç ´' returned 10 results.
[DEBUG] Found 3 novels with local covers
[INFO] Downloaded cover for novel 7189971807603002425 from https://...
[INFO] Downloaded cover for novel 7366526981938088984 from https://...
[INFO] Pre-downloaded 7 covers for search results
```

#### ä¸‹è½½å¤±è´¥

```
[WARNING] Failed to download cover for 7529358240547621950: Connection timeout
```

### ç›‘æ§æŒ‡æ ‡

å»ºè®®ç›‘æ§çš„æŒ‡æ ‡:

- æœç´¢å“åº”æ—¶é—´
- å°é¢ä¸‹è½½æˆåŠŸç‡
- å°é¢ä¸‹è½½å¤±è´¥ç‡
- å¹³å‡å°é¢å¤§å°
- å­˜å‚¨ç©ºé—´ä½¿ç”¨

---

## å­˜å‚¨ç®¡ç†

### ç£ç›˜ç©ºé—´

å‡è®¾:
- å¹³å‡å°é¢å¤§å°: 50KB
- æœç´¢10ä¸ªæ–°å°è¯´: 500KB
- æ¯å¤©æœç´¢100ä¸ªæ–°å°è¯´: 5MB

**å»ºè®®**:
- å®šæœŸæ¸…ç†æœªä¸‹è½½å®Œæˆçš„å°è¯´å°é¢
- å®ç°LRUç¼“å­˜ç­–ç•¥
- è®¾ç½®å­˜å‚¨ä¸Šé™

### æ¸…ç†ç­–ç•¥

```python
# æ¸…ç†è¶…è¿‡30å¤©æœªè®¿é—®çš„å°é¢
def cleanup_old_covers(days=30):
    cutoff = datetime.now() - timedelta(days=days)
    for cover_path in cover_directory.glob('*/*.jpg'):
        if cover_path.stat().st_mtime < cutoff.timestamp():
            cover_path.unlink()
```

---

## å®‰å…¨æ€§

### URLéªŒè¯

```python
# éªŒè¯URLåˆæ³•æ€§
if not cover_url.startswith(('http://', 'https://')):
    return None
```

### æ–‡ä»¶åå®‰å…¨

```python
# æ¸…ç†ç‰¹æ®Šå­—ç¬¦,é˜²æ­¢è·¯å¾„æ³¨å…¥
safe_book_name = re.sub(r'[\\/*?:"<>|]', "_", book_name)
```

### æ–‡ä»¶å¤§å°é™åˆ¶

```python
# é™åˆ¶ä¸‹è½½æ–‡ä»¶å¤§å°
if response.headers.get('Content-Length'):
    size = int(response.headers['Content-Length'])
    if size > 1024 * 1024:  # 1MB
        raise ValueError("Cover file too large")
```

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•å‘½ä»¤

```bash
# æµ‹è¯•1: æœç´¢æ–°å°è¯´(å¯ç”¨é¢„ä¸‹è½½)
curl "http://localhost:5000/api/search?query=ä¿®ä»™&preload_covers=true" | jq

# æµ‹è¯•2: æœç´¢æ–°å°è¯´(ç¦ç”¨é¢„ä¸‹è½½)
curl "http://localhost:5000/api/search?query=ä¿®ä»™&preload_covers=false" | jq

# æµ‹è¯•3: æœç´¢å·²ä¸‹è½½å°è¯´
curl "http://localhost:5000/api/search?query=æ–—ç ´" | jq

# æµ‹è¯•4: æ£€æŸ¥å°é¢æ–‡ä»¶æ˜¯å¦å­˜åœ¨
docker exec fanqie ls -lh /app/data/status/*/*.jpg
```

### éªŒè¯æ­¥éª¤

1. **æœç´¢æ–°å°è¯´**
   - æ£€æŸ¥å“åº”æ—¶é—´
   - éªŒè¯ `cover` å­—æ®µä¸ºæœ¬åœ°URL
   - ç¡®è®¤æ—¥å¿—æ˜¾ç¤ºä¸‹è½½æˆåŠŸ

2. **æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿ**
   ```bash
   docker exec fanqie find /app/data/status -name "*.jpg"
   ```

3. **è®¿é—®å°é¢API**
   ```bash
   curl -I http://localhost:5000/api/novels/{novel_id}/cover
   ```

4. **é‡å¤æœç´¢**
   - éªŒè¯å“åº”æ—¶é—´æ˜æ˜¾ç¼©çŸ­
   - ç¡®è®¤ä¸é‡å¤ä¸‹è½½

---

## ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£ | è¯´æ˜ |
|------|------|
| `SEARCH_COVER_ENHANCEMENT.md` | å°é¢URLä¼˜åŒ–è¯´æ˜ |
| `FRONTEND_SEARCH_ENHANCEMENT.md` | å‰ç«¯æœç´¢é¡µé¢å¢å¼º |
| `API_DOCUMENTATION.md` | å®Œæ•´APIæ–‡æ¡£ |

---

## æ€»ç»“

âœ… **åŠŸèƒ½ç‰¹æ€§**
- è‡ªåŠ¨é¢„ä¸‹è½½æœç´¢ç»“æœå°é¢
- æ™ºèƒ½è·³è¿‡å·²æœ‰å°é¢
- å¯é…ç½®å¯ç”¨/ç¦ç”¨

âœ… **ç”¨æˆ·ä½“éªŒ**
- å°é¢100%å¯ç”¨
- åŠ è½½é€Ÿåº¦å¿«
- äºŒæ¬¡æœç´¢æå¿«

âœ… **æŠ€æœ¯ä¼˜åŠ¿**
- æ‰¹é‡å¤„ç†ä¼˜åŒ–
- æ™ºèƒ½è·³è¿‡æœºåˆ¶
- å®Œå–„çš„é”™è¯¯å¤„ç†

âœ… **æ€§èƒ½å½±å“**
- é¦–æ¬¡æœç´¢ç¨æ…¢(+1-2ç§’)
- åç»­æœç´¢æå¿«
- å¯æ¥å—çš„æŠ˜è¡·

ç°åœ¨æœç´¢æ—¶è‡ªåŠ¨é¢„ä¸‹è½½å°é¢,ä¸ºç”¨æˆ·æä¾›æ›´æµç•…çš„æµè§ˆä½“éªŒ! ğŸ‰
