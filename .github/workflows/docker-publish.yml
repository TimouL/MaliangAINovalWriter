name: Build and Publish Docker Image

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Flutter build deps
        run: sudo apt-get update && sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Build backend jar
        working-directory: AINovalServer
        run: |
          mvn -DskipTests package
          mkdir -p ../deploy/dist
          cp target/*.jar ../deploy/dist/ainoval-server.jar

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.0'
          channel: stable
          cache: true

      - name: Clean Flutter build artifacts
        working-directory: AINoval
        run: |
          flutter clean
          rm -rf build

      - name: Enable web and fetch deps
        working-directory: AINoval
        run: |
          flutter config --enable-web
          flutter pub get

      - name: Build Flutter web (app)
        working-directory: AINoval
        run: flutter build web --release --base-href / --output build/web

      - name: Build Flutter web (admin)
        working-directory: AINoval
        run: flutter build web --release -t lib/admin_main.dart --base-href /admin/ --output build/admin_web

      - name: List Flutter build output
        run: |
          echo "=== Flutter build/web output ==="
          ls -la AINoval/build/web/
          echo ""
          echo "=== JS files in build/web ==="
          ls -la AINoval/build/web/*.js || echo "No JS files"
          echo ""
          echo "=== Flutter build/admin_web output ==="
          ls -la AINoval/build/admin_web/
          echo ""
          echo "=== JS files in build/admin_web ==="
          ls -la AINoval/build/admin_web/*.js || echo "No JS files"

      - name: Flatten Flutter web assets
        run: |
          for dir in AINoval/build/web AINoval/build/admin_web; do
            nested="$dir/assets/assets"
            if [ -d "$nested" ]; then
              cp -a "$nested/." "$dir/assets/"
              # 保留原始 assets/assets 路径，避免运行时仍按双重前缀请求字体/图标
              echo "Flattened (kept) duplicated assets in $dir"
            else
              echo "Skip: no nested assets in $dir"
            fi

            # 确保 PWA 图标既在 icons/ 也在根目录可直连
            for icon in Icon-192.png Icon-512.png Icon-maskable-192.png Icon-maskable-512.png; do
              for candidate in "$dir/icons/$icon" "$dir/$icon" "AINoval/web/icons/$icon"; do
                if [ -f "$candidate" ]; then
                  # 仅在目标不存在且源路径不同的情况下复制，避免同路径报错
                  if [ ! -f "$dir/icons/$icon" ] && [ "$candidate" != "$dir/icons/$icon" ]; then
                    cp "$candidate" "$dir/icons/$icon"
                  fi
                  if [ ! -f "$dir/$icon" ] && [ "$candidate" != "$dir/$icon" ]; then
                    cp "$candidate" "$dir/$icon"
                  fi
                  break
                fi
              done
            done

            # 将清单文件提升到构建根，匹配运行时请求路径
            for manifest in AssetManifest.json AssetManifest.bin AssetManifest.bin.json FontManifest.json NOTICES; do
              if [ -f "$dir/assets/$manifest" ]; then
                cp "$dir/assets/$manifest" "$dir/$manifest"
              fi
            done

            # 确保字体存在并镜像到 /fonts 直连路径
            src_fonts_repo="AINoval/assets/fonts"
            fonts_assets="$dir/assets/fonts"
            mkdir -p "$fonts_assets" "$dir/fonts"
            if [ -d "$src_fonts_repo" ]; then
              rsync -a --ignore-existing "$src_fonts_repo/" "$fonts_assets/"
            fi
            if [ -d "$dir/assets/fonts" ]; then
              rsync -a "$dir/assets/fonts/" "$dir/fonts/"
            fi

            # 确保图标文件存在
            for icon in Icon-192.png Icon-512.png; do
              for candidate in "$dir/$icon" "AINoval/build/web/$icon" "AINoval/build/admin_web/$icon" "AINoval/web/$icon"; do
                if [ -f "$candidate" ]; then
                  # 仅在源与目标不同且未指向同一文件时复制
                  if [ "$candidate" != "$dir/$icon" ] && [ ! "$candidate" -ef "$dir/$icon" ]; then
                    cp "$candidate" "$dir/$icon"
                  fi
                  break
                fi
              done
            done
          done

      - name: Fix package asset paths
        run: |
          for dir in AINoval/build/web AINoval/build/admin_web; do
            pkg_dir="$dir/assets/packages"
            if [ -d "$pkg_dir" ]; then
              mkdir -p "$dir/packages"
              cp -a "$pkg_dir/." "$dir/packages/"
              echo "Copied all package assets from $pkg_dir to $dir/packages"
            else
              echo "Skip: no assets/packages in $dir"
            fi
          done

      - name: Prepare dist assets
        run: |
          rm -rf deploy/dist/web deploy/dist/admin_web
          mkdir -p deploy/dist/web deploy/dist/admin_web
          cp -a AINoval/build/web/. deploy/dist/web/
          cp -a AINoval/build/admin_web/. deploy/dist/admin_web/

          # 基础文件校验，构建缺失则提前失败
          for dir in deploy/dist/web deploy/dist/admin_web; do
            for req in main.dart.js Icon-192.png Icon-512.png; do
              [ -f "$dir/$req" ] || { echo "Missing $req in $dir"; exit 1; }
            done
            if ls "$dir"/main.dart.js_*.part.js >/dev/null 2>&1; then
              echo "Found dart part files in $dir"
            else
              echo "No main.dart.js_* part files in $dir (single bundle)"
            fi
          done

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=sha
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deploy/fanqie-integrated/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
