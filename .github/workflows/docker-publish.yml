name: Build and Publish Docker Image

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Flutter build deps
        run: sudo apt-get update && sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Build backend jar
        working-directory: AINovalServer
        run: |
          mvn -DskipTests package
          mkdir -p ../deploy/dist
          cp target/*.jar ../deploy/dist/ainoval-server.jar

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.0'
          channel: stable
          cache: true

      - name: Enable web and fetch deps
        working-directory: AINoval
        run: |
          flutter config --enable-web
          flutter pub get

      - name: Build Flutter web (app)
        working-directory: AINoval
        run: flutter build web --release --output build/web

      - name: Build Flutter web (admin)
        working-directory: AINoval
        run: flutter build web --release -t lib/admin_main.dart --output build/admin_web

      - name: Fix fluttertoast asset path
        run: |
          for dir in AINoval/build/web AINoval/build/admin_web; do
            src="$dir/assets/packages/fluttertoast/assets/toastify.css"
            if [ -f "$src" ]; then
              mkdir -p "$dir/packages"
              cp -a "$dir/assets/packages/." "$dir/packages/"
              echo "Copied fluttertoast assets into $dir/packages"
            else
              echo "Skip: toastify.css not found under $dir/assets/packages/fluttertoast"
            fi
          done

      - name: Prepare dist assets
        run: |
          rm -rf deploy/dist/web deploy/dist/admin_web
          mkdir -p deploy/dist/web deploy/dist/admin_web
          cp -a AINoval/build/web/. deploy/dist/web/
          cp -a AINoval/build/admin_web/. deploy/dist/admin_web/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=sha

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./deploy
          file: ./deploy/open/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
