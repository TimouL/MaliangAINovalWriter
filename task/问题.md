# 日志审查报告

**审查时间：** 2025-11-28  
**日志时间范围：** 2025-11-28 21:35:34 - 21:42:19

---

## 问题 1：缺少提示词提供器（高优先级）✅ 已修复

**修复提交：** `4378315`

### 错误信息

```
WARN  c.a.s.s.prompt.PromptProviderFactory: 未找到功能类型 SETTING_GENERATION_TOOL 的提示词提供器
ERROR .s.i.UnifiedPromptAggregationServiceImpl: 提示词包构建失败: featureType=SETTING_GENERATION_TOOL, error=不支持的功能类型: SETTING_GENERATION_TOOL

WARN  c.a.s.s.prompt.PromptProviderFactory: 未找到功能类型 KNOWLEDGE_EXTRACTION_SETTING 的提示词提供器
ERROR: 不支持的功能类型: KNOWLEDGE_EXTRACTION_SETTING

WARN  c.a.s.s.prompt.PromptProviderFactory: 未找到功能类型 KNOWLEDGE_EXTRACTION_OUTLINE 的提示词提供器
ERROR: 不支持的功能类型: KNOWLEDGE_EXTRACTION_OUTLINE
```

### 影响

- 前端请求 15 个功能类型的提示词包，但只有 12 个成功，3 个失败
- 每次用户登录或刷新页面都会触发这些错误
- 错误日志级别为 ERROR，会污染日志监控

### 缺失的功能类型

| 功能类型 | 描述 | 是否有对应预设 |
|---------|------|--------------|
| `SETTING_GENERATION_TOOL` | 设定生成工具 | 有系统预设 |
| `KNOWLEDGE_EXTRACTION_SETTING` | 知识提取-设定 | 有系统预设 |
| `KNOWLEDGE_EXTRACTION_OUTLINE` | 知识提取-大纲 | 有系统预设 |

### 相关代码位置

- `PromptProviderFactory.java` - 提示词提供器工厂
- `UnifiedPromptAggregationServiceImpl.java` - 提示词聚合服务

### 建议修复方案

1. 在 `PromptProviderFactory` 中为这 3 个功能类型注册提示词提供器
2. 或者在前端请求时过滤掉这些不支持的功能类型
3. 或者将错误级别降为 WARN/DEBUG，避免污染日志

---

## 问题 2：番茄小说下载任务持续失败（中优先级）✅ 已修复

**修复提交：** `6e97308`

### 错误信息

```
2025-11-28 21:38:29.135 ERROR c.a.server.aspect.SkyWalkingTraceAspect: Service method error: FanqieNovelServiceImpl#getNovelDetail, duration=23ms, error=404 Not Found from GET http://127.0.0.1:5000/api/novels/7189955507229035578

2025-11-28 21:38:39.181 INFO  c.a.s.s.f.impl.FanqieNovelServiceImpl: 任务状态: FAILURE
2025-11-28 21:38:49.190 INFO  c.a.s.s.f.impl.FanqieNovelServiceImpl: 任务状态: FAILURE
2025-11-28 21:38:59.198 INFO  c.a.s.s.f.impl.FanqieNovelServiceImpl: 任务状态: FAILURE
... (持续到 21:42:19，约 20+ 次轮询)
```

### 影响

- 任务失败后持续轮询约 4 分钟，浪费服务器资源
- 每 10 秒轮询一次，产生大量无意义日志
- 用户无法得知具体失败原因

### 问题分析

1. **缺少失败终止机制**：任务状态为 `FAILURE` 后应立即停止轮询
2. **缺少失败原因记录**：只记录状态为 FAILURE，未记录具体错误信息
3. **缺少最大重试限制**：没有设置轮询次数上限
4. **番茄小说服务异常**：下载任务创建后立即失败，可能是番茄小说 Reader 服务问题

### 相关代码位置

- `FanqieNovelServiceImpl.java` - 番茄小说服务
- `KnowledgeExtractionTaskExecutor.java` - 知识提取任务执行器

### 建议修复方案

1. 检测到 `FAILURE` 状态时立即终止轮询并返回错误
2. 添加最大轮询次数限制（如 30 次，即 5 分钟）
3. 记录并返回具体的失败原因给用户
4. 检查番茄小说 Reader 服务（`http://127.0.0.1:5000`）的运行状态

---

## 问题 3：任务状态更新竞争（低优先级）✅ 已修复

**修复提交：** `6569dd9`

### 警告信息

```
2025-11-28 21:38:29.114 WARN c.a.s.t.listener.StateAggregatorService: 无法更新任务2abe4af9-fd60-4752-a317-441a6e931e5c为运行状态，可能已被另一个消费者处理
```

### 影响

- 可能存在任务状态更新的并发竞争
- 在分布式部署场景下可能导致状态不一致

### 相关代码位置

- `StateAggregatorService.java` - 状态聚合服务

### 建议修复方案

1. 使用乐观锁或分布式锁处理状态更新
2. 添加版本号或时间戳进行并发控制
3. 如果是预期行为（如多消费者场景），可将日志级别降为 DEBUG

---

## 其他观察

### 性能观察

- 提示词包构建耗时差异较大：大部分 5-10ms，但 `NOVEL_COMPOSE` 和 `STORY_PLOT_CONTINUATION` 耗时 842-844ms
- 预设聚合数据构建总耗时约 104ms，属于正常范围

### 正常功能

- SSE 连接建立正常
- 用户认证和会话管理正常
- 设定树生成功能正常
- 历史记录查询正常

---

## 优先级排序

| 优先级 | 问题 | 状态 | 提交 |
|-------|------|------|------|
| 高 | 缺少提示词提供器 | ✅ 已修复 | `4378315` |
| 中 | 番茄小说任务轮询 | ✅ 已修复 | `6e97308` |
| 低 | 任务状态竞争 | ✅ 已修复 | `6569dd9` |
| 中 | 问题 4 根因分析 | ✅ 已修复 | `bbe0cb2` |
| 中 | Nginx /fq 端点重定向问题 | ✅ 已解决 | 浏览器缓存问题 |
| 中 | 日志级别配置界面 | ✅ 已修复 | `bbe0cb2` |
| 高 | 番茄小说服务无法下载 | ✅ 已修复 | 切换官方API模式 |
| 高 | KeywordExtractionService Bean 缺失 | ✅ 已修复 | `c7e9fb0` |

---

## 问题 4：任务状态竞争根因分析（中优先级）✅ 已修复

**修复提交：** `bbe0cb2`

### 问题描述

用户反馈：应用中只有一个 admin 账号，下载任务由 admin 创建，没有其他账号，为什么会出现"可能已被另一个消费者处理"的提示？

### 根因分析

查看 `TaskStateServiceImpl.trySetRunning` 方法：

```java
Query query = new Query(Criteria.where("_id").is(taskId)
                           .and("status").in(TaskStatus.QUEUED, TaskStatus.RETRYING));
```

该方法使用原子操作，只有当任务状态是 `QUEUED` 或 `RETRYING` 时才能更新为 `RUNNING`。返回 `false` 的可能原因：

1. **事件重复触发**：`TaskStartedEvent` 被多次发布
2. **状态已更新**：任务状态已经被其他代码路径更新为 `RUNNING`
3. **事件处理顺序问题**：任务执行器在事件监听器之前就更新了状态

### 相关代码位置

- `StateAggregatorService.onTaskStarted()` - 事件监听器
- `TaskStateServiceImpl.trySetRunning()` - 状态更新逻辑
- 任务执行器可能在执行前就更新了状态

### 建议修复方案

1. 检查 `TaskStartedEvent` 的发布位置，确保不会重复发布
2. 添加更详细的日志，记录任务当前状态便于排查
3. 这是预期行为（幂等性保护），日志级别已降为 DEBUG

---

## 问题 5：Nginx /fq 端点重定向问题（中优先级）✅ 已解决

### 问题描述

访问 `/fq` 端点时会跳转到 `域名:18080/fq` 而不是 `/fq/`。

### 解决方案

经确认为浏览器缓存问题，清除缓存后正常工作。

---

## 问题 6：日志级别配置界面（中优先级）✅ 已修复

**修复提交：** `bbe0cb2`

### 问题描述

用户希望：
1. 能通过环境变量或配置控制日志输出级别（如屏蔽 INFO，只显示 ERROR）
2. 在基础设施配置界面中提供日志级别设置

---

## 日志级别配置详解

### 1. 日志级别说明

日志级别从低到高：`TRACE < DEBUG < INFO < WARN < ERROR`

| 级别 | 说明 | 适用场景 |
|------|------|----------|
| TRACE | 最详细的跟踪信息 | 深度调试，生产环境不建议 |
| DEBUG | 调试信息 | 开发环境调试 |
| INFO | 一般信息 | 生产环境默认级别 |
| WARN | 警告信息 | 需要关注但不影响运行 |
| ERROR | 错误信息 | 只显示错误，最精简 |

**设置某级别后，只会输出该级别及以上的日志**。例如设置 `INFO`，则只输出 `INFO`、`WARN`、`ERROR`。

### 2. YAML 配置项含义

```yaml
logging:
  level:
    root: INFO                           # 根级别：所有日志的默认级别
    com.ainovel: DEBUG                   # com.ainovel 包下的所有类
    com.ainovel.server: DEBUG            # com.ainovel.server 包下的所有类
    com.ainovel.server.task: INFO        # com.ainovel.server.task 包（任务模块）
    org.springframework.data.mongodb: INFO  # MongoDB 相关日志
    org.springframework.web: INFO        # Spring Web 相关日志
    reactor.netty: INFO                  # Netty 网络层日志
```

**层级关系**：
- `root` 是最顶层，控制所有未单独配置的日志
- `com.ainovel` 覆盖 `root` 对该包的设置
- `com.ainovel.server.task` 覆盖 `com.ainovel` 对该子包的设置

### 3. 环境变量设置方式

**Linux/Mac：**
```bash
# 方式1：临时设置（当前会话有效）
export LOG_LEVEL_ROOT=ERROR
export LOG_LEVEL_APP=WARN
java -jar ainoval-server.jar

# 方式2：启动命令中设置
LOG_LEVEL_ROOT=ERROR LOG_LEVEL_APP=WARN java -jar ainoval-server.jar

# 方式3：写入 .bashrc 或 .profile（永久生效）
echo 'export LOG_LEVEL_ROOT=ERROR' >> ~/.bashrc
source ~/.bashrc
```

**Windows：**
```cmd
# 方式1：临时设置
set LOG_LEVEL_ROOT=ERROR
set LOG_LEVEL_APP=WARN
java -jar ainoval-server.jar

# 方式2：永久设置（系统环境变量）
setx LOG_LEVEL_ROOT ERROR
```

**Docker：**
```bash
docker run -e LOG_LEVEL_ROOT=ERROR -e LOG_LEVEL_APP=WARN ainoval-server
```

**Docker Compose：**
```yaml
services:
  ainoval:
    environment:
      - LOG_LEVEL_ROOT=ERROR
      - LOG_LEVEL_APP=WARN
```

### 4. 可用的环境变量

| 环境变量 | 控制范围 | 默认值 |
|----------|----------|--------|
| `LOG_LEVEL_ROOT` | 所有日志的默认级别 | INFO |
| `LOG_LEVEL_APP` | 应用代码 (com.ainovel.*) | DEBUG |
| `LOG_LEVEL_TASK` | 任务模块 (com.ainovel.server.task) | INFO |
| `LOG_LEVEL_MONGODB` | MongoDB 相关 | INFO |
| `LOG_LEVEL_WEB` | Spring Web 相关 | INFO |
| `LOG_LEVEL_NETTY` | 网络层 | INFO |
| `LOG_LEVEL_AMQP` | RabbitMQ 相关 | INFO |

### 5. 常见配置场景

**场景1：生产环境只看错误**
```bash
export LOG_LEVEL_ROOT=ERROR
export LOG_LEVEL_APP=ERROR
```

**场景2：生产环境看警告和错误**
```bash
export LOG_LEVEL_ROOT=WARN
export LOG_LEVEL_APP=WARN
```

**场景3：调试任务模块问题**
```bash
export LOG_LEVEL_ROOT=INFO
export LOG_LEVEL_APP=INFO
export LOG_LEVEL_TASK=DEBUG
```

**场景4：调试 MongoDB 问题**
```bash
export LOG_LEVEL_MONGODB=DEBUG
```

### 6. infrastructure.json 配置

也可以在 `config/infrastructure.json` 中配置：

```json
{
  "logging": {
    "rootLevel": "WARN",
    "appLevel": "INFO"
  }
}
```

**优先级**：环境变量 > infrastructure.json > application.yml 默认值

### 7. 管理后台配置

在管理后台 → 基础设施 → 日志配置 中可以设置：
- 根日志级别
- 应用日志级别

修改后需要重启应用生效。

---

## 问题 7：番茄小说服务无法下载（高优先级）

### 问题描述

番茄小说服务运行状态正常，但无法下载小说内容。

### 初步分析

#### 1. 下载模式配置

当前 `.env` 配置：
```
NOVEL_USE_PROXY_API=true      # 启用代理API模式
NOVEL_USE_OFFICIAL_API=false  # 禁用官方API模式
```

#### 2. 代理 API 服务不可用

代理服务地址：`https://fanqie.hnxianxin.cn`

测试结果：**连接失败**（返回 000，无法建立连接）

```bash
curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 "https://fanqie.hnxianxin.cn/content?item_id=7339288006681867812"
# 返回: 000 (连接失败)
```

#### 3. 下载模式优先级

代码中的下载模式选择逻辑（`downloader.py`）：
1. **代理 API 模式**（`use_proxy_api=true`）- 当前启用，但服务不可用
2. **官方 API 模式**（`use_official_api=true`）- 当前禁用
3. **第三方 API 模式**（需配置 `api_endpoints`）- 未配置

#### 4. 上游仓库 2025年10月提交

| 提交 | 说明 |
|------|------|
| `1b1a700` | 修复 SSL 握手错误：在 `get_iid.py` 中绕过本地代理 |
| `b576fe8` | 综合增强：内部 API、搜索改进、代理下载器支持 |
| `d1044e2` | 文档更新 |

本地代码已包含 `1b1a700` 的修复。

### 可能的解决方案

#### 方案 1：切换到官方 API 模式

修改 `.env`：
```
NOVEL_USE_PROXY_API=false
NOVEL_USE_OFFICIAL_API=true
```

**风险**：官方 API 可能有限流，需要有效的 IID。

#### 方案 2：更换代理服务地址

查找其他可用的番茄小说代理服务，更新 `proxy_downloader.py` 中的 `PROXY_BASE_URL`。

#### 方案 3：配置第三方 API 端点

在 `.env` 中配置 `NOVEL_API_ENDPOINTS`，使用第三方 API 服务。

### 修复方案

#### 已实施的修复

1. **切换下载模式**（修改 `.env`）：
   ```
   NOVEL_USE_PROXY_API=false    # 禁用不可用的代理服务
   NOVEL_USE_OFFICIAL_API=true  # 启用官方 API
   NOVEL_IID=                   # 清空过期的 IID，让系统自动生成
   NOVEL_IID_SPAWN_TIME=        # 清空过期时间戳
   ```

2. **改进 IID 生成逻辑**（修改 `downloader.py`）：
   - `_ensure_fresh_iid()` 函数增加错误处理
   - 如果无法保存配置文件，仅记录警告，不影响下载功能
   - IID 在内存中仍然有效

#### 官方 API 测试结果

```bash
curl -s -w "HTTP_CODE: %{http_code}" "https://api5-normal-sinfonlineb.fqnovel.com/reading/reader/full/v1/?item_ids=7339288006681867812&aid=1967"
# 返回: HTTP_CODE: 200 (可访问)
```

### 状态

**已修复** - 需要重启番茄服务验证

---

## 问题 8：KeywordExtractionService Bean 缺失导致启动失败（高优先级）✅ 已修复

**修复提交：** `c7e9fb0`

### 错误信息

```
APPLICATION FAILED TO START

Description:
Parameter 5 of constructor in com.ainovel.server.service.impl.NovelSettingServiceImpl required a bean of type 'com.ainovel.server.service.KeywordExtractionService' that could not be found.

Action:
Consider defining a bean of type 'com.ainovel.server.service.KeywordExtractionService' in your configuration.
```

### 依赖链

```
NovelSettingHistoryController 
  → NovelSettingHistoryServiceImpl 
    → NovelSettingServiceImpl 
      → KeywordExtractionService (缺失!)
```

### 根因分析

`KeywordExtractionServiceImpl` 有条件注解：
```java
@Service
@ConditionalOnProperty(name = "ai.gemini.enabled", havingValue = "true", matchIfMissing = false)
public class KeywordExtractionServiceImpl implements KeywordExtractionService {
```

只有当 `ai.gemini.enabled=true` 时才会创建 Bean。但 `NovelSettingServiceImpl` 使用 `@RequiredArgsConstructor` 将其作为 `final` 字段，导致成为必需依赖。

### 修复方案

将 `KeywordExtractionService` 改为可选依赖：

```java
// 修改前
private final KeywordExtractionService keywordExtractionService;

// 修改后
@Autowired(required = false)
private KeywordExtractionService keywordExtractionService;
```

### 影响

- 当 `ai.gemini.enabled` 未设置或为 `false` 时，应用可以正常启动
- 关键词提取功能在服务不可用时会优雅降级（代码中已有 `!= null` 检查）

### 相关代码位置

- `NovelSettingServiceImpl.java` - 小说设定服务
- `KeywordExtractionServiceImpl.java` - 关键词提取服务实现

### KeywordExtractionService 服务分析

#### 服务作用

`KeywordExtractionService` 用于从小说文本中提取关键词（人物、地点、物品、组织、概念等），主要用于：

1. **设定检索优化** - 在 `retrieveRelevantSettings()` 中从上下文提取关键词，辅助向量搜索
2. **设定索引构建** - 在 `indexSettingItem()` 中为设定条目提取关键词，存入向量库元数据

#### 为什么依赖 Gemini？

这是**历史遗留设计**：

1. **早期实现** - 最初选择 Gemini Flash 作为轻量级关键词提取模型（便宜、快速）
2. **硬编码配置** - 默认模型 `gemini-2.0-flash`，API Key 直接读取 `ai.gemini.api-key`
3. **已废弃** - 代码中标注了 `@Deprecated`，注释说明"请使用后台配置的公共模型"

#### 当前状态

**实际上这个服务已经被禁用了：**

```java
// 服务已废弃：直接返回空列表，避免直连旧入口
Mono.just(java.util.Collections.<String>emptyList())
```

调用处也被注释掉了：
```java
// 1. 使用LLM从上下文中提取关键词 - 暂时注释掉以避免额外的AI调用
Mono<List<String>> keywordsMono = Mono.just(Collections.emptyList());
```

#### 结论

- **功能已废弃**，实际返回空列表
- **不应该强依赖 Gemini**，这是历史遗留问题
- **可以考虑完全移除**，或改用后台配置的公共模型

---

## 问题 9：环境变量命名不统一（中优先级）✅ 已修复

**修复提交：** `af69742`, `89debca`

### 问题描述

在基础设施配置管理界面开发过程中，发现多处环境变量命名不一致：

1. `application-prod.yml` 与 `deploy/open/production.env` 中的变量名不匹配
2. `InfrastructureConfigLoader.java` 检查的环境变量名与实际使用的不一致
3. `production.env` 中存在重复定义的变量

### 不一致清单

| 用途 | production.env 中 | application-prod.yml 中 | InfrastructureConfigLoader 检查 |
|------|------------------|------------------------|-------------------------------|
| Chroma 启用 | `VECTORSTORE_CHROMA_ENABLED` | `CHROMA_ENABLED` | `CHROMA_ENABLED` |
| OpenAI Key | `AI_OPENAI_API_KEY` + `OPENAI_API_KEY` | `OPENAI_API_KEY` | - |
| Gemini Key | `AI_GEMINI_API_KEY` + `GEMINI_API_KEY` | `GEMINI_API_KEY` | - |
| OSS Endpoint | `ALIYUN_OSS_ENDPOINT` | `ALIYUN_OSS_ENDPOINT` | `OSS_ENDPOINT` |
| OSS AccessKeyId | `ALIYUN_OSS_ACCESS_KEY_ID` | `ALIYUN_OSS_ACCESS_KEY_ID` | `OSS_ACCESS_KEY_ID` |
| 属性路径 | - | `ainovel.storage.*` | `storage.*` |

### 修复内容

#### 1. 统一环境变量命名（以 production.env 为准）

| 用途 | 统一变量名 |
|------|-----------|
| MongoDB URI | `SPRING_DATA_MONGODB_URI` |
| Chroma 启用 | `VECTORSTORE_CHROMA_ENABLED` |
| Chroma URL | `CHROMA_URL` |
| Chroma Token | `CHROMA_AUTH_TOKEN` |
| OpenAI Key | `AI_OPENAI_API_KEY` |
| Gemini Key | `AI_GEMINI_API_KEY` |
| 存储提供者 | `STORAGE_PROVIDER` |
| OSS 配置 | `ALIYUN_OSS_ENDPOINT`, `ALIYUN_OSS_ACCESS_KEY_ID`, `ALIYUN_OSS_ACCESS_KEY_SECRET`, `ALIYUN_OSS_BUCKET_NAME`, `ALIYUN_OSS_BASE_URL`, `ALIYUN_OSS_REGION` |
| JWT | `JWT_SECRET` |
| 代理 | `PROXY_ENABLED`, `PROXY_HOST`, `PROXY_PORT` |
| 设定树初始化 | `AINOVEL_AI_FEATURES_SETTING_TREE_GENERATION_INIT_ON_STARTUP` |

#### 2. 修复 application-prod.yml

```yaml
# Chroma
enabled: ${VECTORSTORE_CHROMA_ENABLED:false}

# AI Keys
openai:
  api-key: ${AI_OPENAI_API_KEY:}
gemini:
  api-key: ${AI_GEMINI_API_KEY:}
```

#### 3. 修复 application.yml

```yaml
# 设定树初始化
init-on-startup: ${AINOVEL_AI_FEATURES_SETTING_TREE_GENERATION_INIT_ON_STARTUP:true}

# Chroma
enabled: ${VECTORSTORE_CHROMA_ENABLED:false}
```

#### 4. 修复 InfrastructureConfigLoader.java

```java
// Chroma 启用状态检查
String envEnabled = env.getProperty("VECTORSTORE_CHROMA_ENABLED");

// OSS 配置 - 使用 ALIYUN_OSS_* 环境变量
setPropertyIfNotEmpty(oss, "endpoint", "ainovel.storage.aliyun.endpoint", env, "ALIYUN_OSS_ENDPOINT");
setPropertyIfNotEmpty(oss, "accessKeyId", "ainovel.storage.aliyun.access-key-id", env, "ALIYUN_OSS_ACCESS_KEY_ID");
// ... 其他 OSS 配置

// 属性路径修复：storage.* → ainovel.storage.*
System.setProperty("ainovel.storage.default-provider", ...);
System.setProperty("ainovel.storage.local.base-path", ...);
```

#### 5. 清理 production.env

移除重复定义的变量：
- `OPENAI_API_KEY=` （使用 `AI_OPENAI_API_KEY`）
- `GEMINI_API_KEY=` （使用 `AI_GEMINI_API_KEY`）
- `ANTHROPIC_API_KEY=` （未使用）
- 重复的 `FANQIE_API_PUBLIC_URL`

#### 6. 更新 README.md

```markdown
- AI Key：`AI_OPENAI_API_KEY`、`AI_GEMINI_API_KEY` 等（通过后台"公共模型管理"配置更佳）
```

### 相关文件

- `AINovalServer/src/main/resources/application-prod.yml`
- `AINovalServer/src/main/resources/application.yml`
- `AINovalServer/src/main/java/com/ainovel/server/config/infrastructure/InfrastructureConfigLoader.java`
- `deploy/open/production.env`
- `deploy/open/production.env.example`
- `deploy/open/README.md`

---

## 问题 10：环境变量已配置但仍进入初始化向导（高优先级）✅ 已修复

**修复提交：** `548c588`

### 问题描述

在 HuggingFace 部署中，即使环境变量 `SPRING_DATA_MONGODB_URI` 已设置有效值，访问 admin 端点时仍然进入非预期的初始化引导页。

### 根因分析

`InfrastructureStatusManager.loadSetupStatus()` 方法判断是否需要初始化向导的逻辑：

```java
private void loadSetupStatus() {
    File configFile = new File("config/infrastructure.json");
    if (configFile.exists()) {
        // 从文件读取 setupCompleted
    } else {
        this.setupCompleted = false;  // 文件不存在则需要初始化
    }
}
```

**问题**：只检查 `config/infrastructure.json` 文件，不考虑环境变量配置。在容器化部署中，配置通常通过环境变量传递，而非配置文件。

### 修复方案

优先检查环境变量，如果 `SPRING_DATA_MONGODB_URI` 已设置，则跳过初始化向导：

```java
private void loadSetupStatus() {
    // 优先检查环境变量：如果 MongoDB URI 已通过环境变量配置，跳过初始化向导
    String mongoUri = System.getenv("SPRING_DATA_MONGODB_URI");
    if (mongoUri != null && !mongoUri.isEmpty()) {
        this.setupCompleted = true;
        log.info("检测到环境变量 SPRING_DATA_MONGODB_URI，跳过初始化向导");
        return;
    }
    // ... 原有逻辑
}
```

### 相关文件

- `AINovalServer/src/main/java/com/ainovel/server/config/infrastructure/InfrastructureStatusManager.java`

---

## 问题 11：番茄小说配置页面空白 (`charCodeAt` 错误)（高优先级）✅ 已修复

**修复提交：** `40f1fe7`

### 问题描述

访问番茄小说配置页面时，前端报 `charCodeAt` 错误导致页面空白。

### 根因分析

后端 `FanqieApiConfigService.ConfigSnapshot` 中的 `lastLoadTime` 字段是 `LocalDateTime` 类型，Jackson 序列化为数组格式（如 `[2025,11,30,10,30,45]`），前端尝试作为字符串处理时调用 `charCodeAt` 导致错误。

### 修复方案

将 `lastLoadTime` 类型改为 `String`，添加 `formatDateTime()` 方法将 `LocalDateTime` 格式化为 `"yyyy-MM-dd HH:mm:ss"` 字符串。

### 相关文件

- `AINovalServer/src/main/java/com/ainovel/server/service/fanqie/FanqieApiConfigService.java`

---

## 问题 12：Chroma 向量库配置未正确读取环境变量（中优先级）✅ 已修复

**修复提交：** `40f1fe7`

### 问题描述

配置文件使用 `VECTORSTORE_CHROMA_ENABLED`，但用户设置的是 `CHROMA_ENABLED`，导致 Chroma 向量库无法正确启用。

### 修复方案

修改 `application.yml` 和 `application-prod.yml`，使用嵌套占位符支持两种环境变量名：

```yaml
enabled: ${VECTORSTORE_CHROMA_ENABLED:${CHROMA_ENABLED:false}}
```

### 相关文件

- `AINovalServer/src/main/resources/application.yml`
- `AINovalServer/src/main/resources/application-prod.yml`

---

## 问题 13：前端解析 Chroma 配置字段名不匹配（中优先级）✅ 已修复

**修复提交：** `9cbd73c`

### 问题描述

后端返回扁平结构（`chromaEnabled`），前端期望嵌套结构（`chroma.enabled`），导致配置解析失败。

### 修复方案

更新 `infrastructure_config_screen.dart` 支持两种格式：

```dart
chromaEnabled: json['chroma']?['enabled'] ?? json['chromaEnabled'] ?? false
```

### 相关文件

- `AINoval/lib/screens/admin/infrastructure_config_screen.dart`

---

## 问题 14：MongoDB 连接池耗尽导致 504 超时（高优先级）✅ 已修复

**修复提交：** `cfffc3c`

### 问题描述

拆书任务启动后大量并发数据库操作消耗连接池，SSE 长连接等待超时返回 504。

### 根因分析

MongoDB 默认连接池配置过小，当并发任务增多时，连接池被耗尽，新请求只能等待连接释放，最终触发网关超时。

### 修复方案

在 `MongoConfig.java` 中添加连接池配置：

```java
MongoClientSettings.builder()
    .applyConnectionString(connectionString)
    .applyToConnectionPoolSettings(builder -> builder
        .maxSize(100)              // 最大连接数
        .minSize(10)               // 最小连接数
        .maxWaitTime(30, TimeUnit.SECONDS)
        .maxConnectionIdleTime(10, TimeUnit.MINUTES)
        .maxConnectionLifeTime(30, TimeUnit.MINUTES)
    )
    .build();
```

### 相关文件

- `AINovalServer/src/main/java/com/ainovel/server/config/MongoConfig.java`

---

## 问题 15：SSE 版本检测轮询优化（高优先级）✅ 已修复

**修复提交：** `fec02e5`

### 问题描述

`TaskStatusController` 中每 20 秒执行一次 `findUserById` 轮询检测用户版本，增加数据库压力，尤其在多用户场景下。

### 修复方案

1. **新增 `SseConnectionManager` 服务**：维护用户ID到SSE Sink的映射，支持主动向指定用户推送事件

2. **`TaskStatusController` 移除 20 秒版本检测轮询**：心跳仅发送 keepalive，不再查询数据库

3. **`AdminUserServiceImpl` 主动强制登出**：
   - 当用户状态变更为非 ACTIVE 时，调用 `sseConnectionManager.forceLogout()`
   - 当 tokenVersion 变更时，调用 `sseConnectionManager.forceLogout()`

### 优势

- 移除轮询后，权限变更即时生效
- 显著减少数据库查询压力
- SSE 连接管理更加集中可控

### 相关文件

- `AINovalServer/src/main/java/com/ainovel/server/service/SseConnectionManager.java` (新增)
- `AINovalServer/src/main/java/com/ainovel/server/web/controller/TaskStatusController.java`
- `AINovalServer/src/main/java/com/ainovel/server/service/impl/AdminUserServiceImpl.java`

---

## 问题 16：基础设施配置 UI 增强（中优先级）✅ 已完成

### 实施内容

#### 1. 后端 - InfrastructureConfigService 扩展

在 `InfrastructureConfigDTO` 中新增字段：

```java
// MongoDB 连接池配置
private int mongoPoolMaxSize;    // 最大连接数（默认100）
private int mongoPoolMinSize;    // 最小连接数（默认10）
private int mongoPoolMaxWaitTime;  // 等待超时（秒）
private int mongoPoolMaxIdleTime;  // 空闲超时（秒）

// 任务系统配置
private String taskTransport;      // 传输模式（local/rabbitmq）
private int taskLocalConcurrency;  // 本地并发数
```

支持通过环境变量配置：
- `SPRING_DATA_MONGODB_POOL_MAX_SIZE`
- `SPRING_DATA_MONGODB_POOL_MIN_SIZE`
- `TASK_LOCAL_CONCURRENCY`

#### 2. 前端 - infrastructure_config_screen.dart 更新

**MongoDB 设置块增强：**
- 新增连接池配置可折叠面板（ExpansionTile）
- 显示最大/最小连接数、等待超时、空闲超时
- 每项配置带有工具提示说明

**新增任务系统设置块：**
- 显示传输模式（本地/RabbitMQ）
- 显示并发数配置
- 根据并发数显示等级标签（低/中/高/极高）
- 环境变量配置提示

### 相关文件

- `AINovalServer/src/main/java/com/ainovel/server/service/setup/InfrastructureConfigService.java`
- `AINoval/lib/screens/admin/infrastructure_config_screen.dart`

---

## 问题 17：MongoDB 连接池耗尽导致 500 错误（紧急）✅ 已修复

**修复提交：** `956b680`

### 错误信息

```
Timed out after 30000 ms while waiting for a connection
```

### 根因分析

1. **章节获取并发请求**：`KnowledgeExtractionTaskExecutor` 使用 `flatMap(..., 2)` 并发获取章节
2. **MongoDB Atlas M0 限制**：免费版连接数限制严格（约 500 连接）
3. **连接池配置过大**：`maxSize=100` 对 Atlas M0 压力过大
4. **等待超时过长**：`maxWaitTime=30s` 导致请求长时间挂起

### 修复方案

#### 1. 章节获取串行化
```java
// 修改前
.flatMap(chapterInfo -> fetchChapterContent(...), 2)

// 修改后
.concatMap(chapterInfo -> fetchChapterContent(...))
```

#### 2. 降低连接池配置
- `maxSize`: 100 → 50
- `minSize`: 10 → 5
- `maxWaitTime`: 30s → 10s

### 相关文件

- `AINovalServer/src/main/java/com/ainovel/server/config/MongoConfig.java`
- `AINovalServer/src/main/java/com/ainovel/server/task/executor/KnowledgeExtractionTaskExecutor.java`
- `AINoval/lib/screens/admin/infrastructure_config_screen.dart`

---

## 问题 18：基础设施配置 UI 编辑功能和来源显示（中优先级）✅ 已修复

**修复提交：** `e5913f9`

### 实施内容

#### 1. 后端 - 配置来源检测机制

新增 `detectConfigSource()` 方法，检测配置值来源：
- `"env"`: 系统环境变量
- `"config"`: 配置文件（application.properties/yml）
- `"default"`: 默认值

```java
private String detectConfigSource(String envVarName) {
    String envValue = System.getenv(envVarName);
    if (envValue != null && !envValue.isEmpty()) return "env";
    String propValue = environment.getProperty(envVarName);
    if (propValue != null && !propValue.isEmpty()) return "config";
    return "default";
}
```

#### 2. 后端 - 配置更新 API

新增两个 PUT 端点：
- `PUT /api/v1/admin/config/mongo-pool` - 更新 MongoDB 连接池配置
- `PUT /api/v1/admin/config/task` - 更新任务系统配置

DTO 扩展：
- `MongoPoolConfigUpdate(maxSize, minSize, maxWaitTime, maxIdleTime)`
- `TaskConfigUpdate(transport, localConcurrency)`

#### 3. 前端 - 编辑界面实现

**MongoDB 设置块：**
- 添加编辑模式切换按钮
- 编辑模式下显示 TextField 输入表单
- 环境变量配置时显示黄色警告提示

**任务系统设置块：**
- 添加编辑模式切换按钮
- SegmentedButton 切换传输模式（本地/RabbitMQ）
- TextField 编辑并发数
- 环境变量配置时显示警告

**配置来源显示：**
- `_buildSourceChip()` 显示配置来源 Chip
- 环境变量：绿色 "环境变量"
- 配置文件：蓝色 "配置文件"
- 默认值：灰色 "默认值"

### 相关文件

- `AINovalServer/src/main/java/com/ainovel/server/service/setup/InfrastructureConfigService.java`
- `AINovalServer/src/main/java/com/ainovel/server/web/controller/admin/InfrastructureConfigController.java`
- `AINoval/lib/screens/admin/infrastructure_config_screen.dart`

---

## 已完成任务汇总

| 提交 | 问题 | 状态 |
|------|------|------|
| `40f1fe7` | 番茄配置页面空白 + Chroma 环境变量读取 | ✅ |
| `9cbd73c` | 前端 Chroma 配置字段名兼容 | ✅ |
| `cfffc3c` | MongoDB 连接池配置（maxSize=100, minSize=10）| ✅ |
| `fec02e5` | SSE 主动推送机制（SseConnectionManager）| ✅ |
| `956b680` | MongoDB 连接池耗尽紧急修复（concatMap+降低配置）| ✅ |
| `e5913f9` | 基础设施配置 UI 编辑功能 + 配置来源显示 | ✅ |
